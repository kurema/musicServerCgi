<!DOCTYPE html>

<html>
<head>
<title>再生</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style type="text/css">
<!--
div.tab div{
margin:0px;
padding:5px 10px;
display:inline-flex;
}

div.tab div p{
margin:5px 5px;
}
div.tab div.selected_tab{
font-weight:800;
border-bottom:2px solid #ff5722;
}

div.song{
box-shadow:0 0 8px rgba(0,0,0,.4);
margin:20px;
overflow:auto;
background-color:#fff;
}

div.container{
display:flex;
margin:10px;
flex-wrap:wrap;
justify-content:flex-start;
}
div.container div.material_card{
background-color:#fff;
width:170px;
height:220px;
box-shadow:0 0 8px rgba(0,0,0,.4);
margin:10px;
overflow:hidden;
}
div.container div.material_card img{
width:170px;
height:170px;
}
div.container div.material_card div{
padding:0 8px;
}
div.container div.material_card div p{
margin:0px;
padding:0px;
white-space: nowrap;
}
div.container div.material_card div p.title{
font-size:14px;
}
div.container div.material_card div p.detail{
font-size:12px;
color:#444;
}
div.song table{
width:100%;
table-layout:auto;
border-spacing:5px;
}
div.song table tr{
overflow:hidden;
white-space:nowrap;
padding:3px;
}
div.song table tr td{
overflow:hidden;
padding:5px;
}
@media screen and (max-width: 599px) {
div.container div.material_card{
width:150px;
height:200px;
}
div.container div.material_card img{
width:150px;
height:150px;
}
div.container div.material_card div p.title{
font-size:12px;
}
div.container div.material_card div p.detail{
font-size:10px;
}
div.song table{
border-spacing:15px;
}
}
-->
</style>
</head>
<body style="margin:0;background-color:#DDD;">

<div id="tab" class="tab" style="display:flex;background-color:#fff;box-shadow:0 0 8px rgba(0,0,0,.4);">
<div id="tab_artist" onClick="SelectArtist()">
<p>アーティスト</p>
</div>
<div id="tab_album" onClick="SelectAlbum()">
<p>アルバム</p>
</div>
<div id="tab_song" onClick="SelectSong()">
<p>全曲</p>
</div>
<div id="tab_result">
<p>検索結果</p>
</div>
</div>
<div style="position:fixed;top:60px;width:100%;height:calc(100% - 90px - 60px);overflow-y:auto;">
<div id="container" class="container">
</div>
<div id="song" class="song">
<table id="table_song">
</table>
</div>
</div>
<div id="controler"
 style="box-shadow:0 0 8px rgba(0,0,0,.4);background-color:#fff;height:90px;position:fixed;bottom:0;width:100%;">
<audio id="audio" controls style="width:100%;" autoplay></audio>
</div>
<script>
//<[CDATA[
var Album;
var Song;
var Artist;

GetAlbumAll(function(){});
GetSongAll(function(){});
GetArtistAll(function(){SelectArtist();});

function SelectTag(id){
  for(key in document.getElementById("tab").childNodes){
    var elem=document.getElementById("tab").childNodes[key];
    if(elem.tagName=="DIV"){
      elem.removeAttribute("class");
    }
  }
  document.getElementById(id).setAttribute("class","selected_tab");
}
function SelectSong(){
  SelectTag("tab_song");
  var container = document.getElementById("container");
  ClearChild(container);
  var songs=Song;
  songs.sort(SortSongs);
  SetSongToTable(songs,[new SongInfoTable("#","Track"),new SongInfoTable("曲名","Title")
    ,new SongInfoTable("アーティスト","ArtistName"),new SongInfoTable("アルバム","AlbumName")]);
}
function SelectArtist(){
  SelectTag("tab_artist");
  var container = document.getElementById("container");
  ClearChild(container);
  ClearChild(document.getElementById("table_song"));
  var PushedArtist={};
  for(key in Album){
    var artId=Album[key]["ArtistID"];
    PushedArtist[artId]=GetArtistById(artId);
  }
  var tempList=[];
  for(key in PushedArtist){
    tempList.push(PushedArtist[key]);
  }
  tempList.sort(function(a,b){if(a["Name"]>b["Name"]){return 1;}else{return -1;}});
  for(item in tempList){
    var tempTitle="Unknown";
    if(! tempList[item]){tempTitle="Unkown";}
    else if(! tempList[item]["Name"]){tempTitle="Unkown";}
    else{tempTitle=tempList[item]["Name"];}

    PushCardToContainer(container,tempTitle,"","sb.svg","",
//      (function(id){return function(id){ShowArtist(id);}})(tempList[item]["Id"]));
      (function(id){return function(){ShowArtist(id);}})(tempList[item]["Id"]));
//      function(id){ShowArtist(tempList[item]["Id"]);});
  }
}
function GetArtistById(id){
  return Artist[parseInt(id)-1];
}
function GetAlbumById(id){
  return Album[parseInt(id)-1];
}

function PlaySong(id){
  var audio = document.getElementById("audio");
  audio.src = "music.cgi?f=wav&id="+id;
}
function SelectAlbum(){
  SelectTag("tab_album");
  var container = document.getElementById("container");
  ClearChild(container);
  ClearChild(document.getElementById("table_song"));
  var tempList=[];
  for(key in Album){
    tempList.push(Album[key]);
  }
  tempList.sort(function(a,b){
    var arta=GetArtistById(a["ArtistID"]);
    var artb=GetArtistById(b["ArtistID"]);
    if(arta["Name"]>artb["Name"]){
      return 1;
    }else if(arta["Name"]==artb["Name"]){
      if(a["Title"]>b["Title"]){return 1;}else{return -1;}
    }else{
      return -1;}
    });
  for(item in tempList){
    PushCardToContainer(container,tempList[item]["Title"],GetArtistById(tempList[item]["ArtistID"])["Name"],"thumb.cgi?id="+tempList[item]["Id"],"sb.svg",
      (function(id){return function(){ShowAlbum(id);}})(tempList[item]["Id"]));
  }
}
function SortSongs(a,b){
  var albuma=GetAlbumById(a["AlbumId"]);
  var albumb=GetAlbumById(b["AlbumId"]);
  var arta=GetArtistById(albuma["ArtistID"]);
  var artb=GetArtistById(albumb["ArtistID"]);
  if(arta["Name"]>artb["Name"]){return 1;}
  else if(arta["Name"]<artb["Name"]){return -1;}
  else{
    if(albuma["Title"]>albumb["Title"]){return 1;}
    else if(albuma["Title"]<albumb["Title"]){return -1;}
    else{
      var tra=parseInt(a["Track"]);
      var trb=parseInt(b["Track"]);
      if(tra>trb){return 1;}
      else{return -1;}
    }
  }
}
function ShowArtist(artistid){
  SelectTag("tab_result");
  var artist=GetArtistById(artistid);
  var container = document.getElementById("container");
  ClearChild(container);
  ClearChild(document.getElementById("table_song"));
  var tempList=[];
  for(key in Album){
    if(Album[key]["ArtistID"] == artistid){
      tempList.push(Album[key]);
    }
  }
  tempList.sort(function(a,b){if(a["Title"]>b["Title"]){return 1;}else{return -1;}});
  for(item in tempList){
    PushCardToContainer(container,tempList[item]["Title"],artist["Name"],"thumb.cgi?id="+tempList[item]["Id"],"sb.svg"
      ,(function(id){return function(){ShowAlbum(id);}})(tempList[item]["Id"]));
  }
  var tempListS=[];
  for(key in Song){
    if(Song[key]["ArtistID"] == artistid || GetAlbumById(Song[key]["AlbumId"])["ArtistID"]== artistid){
      tempListS.push(Song[key]);
    }
  }
  tempListS.sort(SortSongs);
  SetSongToTable(tempListS,[new SongInfoTable("番号","Track"),new SongInfoTable("曲名","Title")]);
}
function ShowAlbum(albumid){
  SelectTag("tab_result");
  var tempAlbum=GetAlbumById(albumid);
  var container = document.getElementById("container");
  ClearChild(container);
  ClearChild(document.getElementById("table_song"));
  PushCardToContainer(container,tempAlbum["Title"],"","thumb.cgi?id="+tempAlbum["Id"],"sb.svg");
  var tempListS=[];
  for(key in Song){
    if(Song[key]["AlbumId"] == albumid){
      tempListS.push(Song[key]);
    }
  }
  tempListS.sort(SortSongs);
  SetSongToTable(tempListS,[new SongInfoTable("番号","Track"),new SongInfoTable("曲名","Title")]);
}
function ClearChild(container){
  while(container.hasChildNodes()){container.removeChild(container.lastChild);}
}
function SetSongToTable(songs,infos){
  var table=document.getElementById("table_song");
  ClearChild(table);
  var tr=document.createElement("tr");
  //tr.appendChild(document.createElement("th"));
  for(key2 in infos){
    var th=document.createElement("th");
    th.innerText=infos[key2].head;
    tr.appendChild(th);
  }
  table.appendChild(tr);
  for(key in songs){
    var tr=document.createElement("tr");
/*
    var td=document.createElement("td");
    var button=document.createElement("button");
    button.innerText="再生";
    //var func=(function(id){return function(){PlaySong(id);}})(songs[key]["Id"]);
    button.setAttribute("onclick","PlaySong("+songs[key]["Id"]+")");
    td.appendChild(button);
    tr.appendChild(td);*/

    var songsInfo=songs[key];
    songsInfo["ArtistName"]=GetArtistById(songsInfo["ArtistID"])["Name"];
    var albumInfo=GetAlbumById(songsInfo["AlbumId"]);
    songsInfo["AlbumName"]=albumInfo["Title"];
    songsInfo["AlbumTrack"]=albumInfo["Tracks"];
    songsInfo["AlbumArtist"]=GetArtistById(albumInfo["ArtistID"])["Name"];
    for(key2 in infos){
      var td=document.createElement("td");
      td.innerText=songs[key][infos[key2].key];
      tr.appendChild(td);
    }
    tr.setAttribute("onclick","PlaySong("+songs[key]["Id"]+")");
    table.appendChild(tr);
  }
}
function SongInfoTable(head,key){
  this.head=head;
  this.key=key;
}
function PushCardToContainer(container,title,detail,imgsrc,altimg,func){
  var div=document.createElement("div");
  div.setAttribute("class","material_card");
  div.innerHTML="<img src='"+imgsrc+"' onerror=\"this.src='"+altimg+"'\"/><div><p class='title'>"
    +title+"</p><p class='detail'>"+detail+"</p></div>";
//  div.onclick=func;
  div.addEventListener("click",func,false);
  container.appendChild(div);
}
function GetAlbumAll(callback){
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function()
{
  if( this.readyState == 4 && this.status == 200 )
  {
    Album = this.response;
    callback();
  }
}

xhr.open( 'GET', 'api.cgi/album/', true );
xhr.responseType = 'json';
xhr.send( null );
}
function GetSongAll(callback){
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function()
{
  if( this.readyState == 4 && this.status == 200 )
  {
    Song = this.response;
    callback();
  }
}

xhr.open( 'GET', 'api.cgi/song/', true );
xhr.responseType = 'json';
xhr.send( null );
}
function GetArtistAll(callback){
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function()
{
  if( this.readyState == 4 && this.status == 200 )
  {
    Artist = this.response;
    callback();
  }
}

xhr.open( 'GET', 'api.cgi/artist/', true );
xhr.responseType = 'json';
xhr.send( null );
}
//]]>
</script>
</body>
</html>
